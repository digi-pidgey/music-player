<!DOCTYPE html>
<html lang="en-us">
<script src="https://pygame-web.github.io/archives/0.9/pythons.js" type=module id=site
    data-LINES=57 data-CONSOLE=25 data-python=python3.12 data-os=vtx,fs,snd,gui async defer>
#<!--

print("Booting up Pygbag...")

# screen size placeholders
WIDTH = 0
HEIGHT = 0
REFX = 1980
REFY = 1080

def u(real, ref, v):
    if abs(v) < 0.9999999:
        result = int((float(real) / 100.0) * (v * 1000))
        if v < 0:
            return real - result
        return result
    return int((real / ref) * v)

def ux(*argv):
    global WIDTH, REFX
    acc = 0
    for v in argv:
        acc += u(WIDTH, REFX, v)
    return acc

def uy(*argv):
    global HEIGHT, REFY
    acc = 0
    for v in argv:
        acc += u(HEIGHT, REFY, v)
    return acc

async def custom_site():
    import sys, asyncio, platform, json
    from pathlib import Path
    import embed

    platform.document.body.style.background = "#000000"

    import pygame

    def compose():
        pygame.display.update()
        window.chromakey(None, *screen.get_colorkey(), 40)

    pygame.init()
    pygame.font.init()

    screen = pygame.display.set_mode([ux(.100), uy(.100)], pygame.SRCALPHA, 32)
    screen.set_colorkey((0, 0, 0, 0), pygame.RLEACCEL)
    screen.fill((0, 0, 0, 0))
    compose()

    platform.window.transfer.hidden = True
    platform.window.canvas.style.visibility = "visible"

    apk = "main.-.copy.apk"
    bundle = "main.-.copy"
    appdir = Path(f"/data/data/{bundle}")
    appdir.mkdir()

    cfg = {
        "io": "url",
        "type": "mount",
        "mount": {
            "point": appdir.as_posix(),
            "path": "/",
        },
        "path": f"/ => {appdir.as_posix()}",
    }

    track = platform.window.MM.prepare(apk, json.dumps(cfg))
    marginx = ux(.020)
    marginy = uy(.045)

    def pg_bar(pos):
        nonlocal marginx, marginy
        total = track.len or 10
        slot = ux(.060) / total
        pygame.draw.rect(screen, (0, 0, 0), (marginx - ux(10), marginy - uy(10), (total * slot) + ux(20), uy(110)))
        pygame.draw.rect(screen, (0, 0, 0), (marginx, marginy, track.pos * slot, uy(90)))

    while not track.ready:
        pg_bar(track.pos)
        compose()
        await asyncio.sleep(.1)

    pg_bar(track.len)
    compose()

    platform.run_main(PyConfig, loaderhome=appdir / "assets", loadermain=None)

    while embed.counter() < 0:
        await asyncio.sleep(.1)

    main = appdir / "assets" / "main.py"
    await TopLevel_async_handler.start_toplevel(platform.shell, console=window.python.config.debug)
    __import__(__name__).__file__ = str(main)

    import pygame
    if hasattr(platform.window, "user_interacted") and platform.window.user_interacted:
        pygame.mixer.init()
        pygame.mixer.music.load("leadwave memories.ogg")
        pygame.mixer.music.set_volume(0.1)
        pygame.mixer.music.play(-1)

    await shell.runpy(main)

import asyncio
asyncio.run(custom_site())

# -->
</script>

<head>
    <script type="application/javascript">
        // Capture first user interaction to satisfy autoplay policy
        window.user_interacted = false;

        window.addEventListener('click', function () {
            window.user_interacted = true;
            console.log('User interaction detected, autoplay flag set.');
        }, { once: true });
    </script>

    <meta charset="UTF-8">
    <title>main.-.copy</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            margin: 0;
            background: black;
        }

        canvas.emscripten {
            border: none;
            background-color: black;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }
    </style>
</head>

<body>
    <div id="transfer" align=center>
        <div class="emscripten" id="status">Downloading...</div>
        <div class="emscripten">
            <progress value="100" max="100" id="progress"></progress>
        </div>
    </div>

    <canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()" tabindex=1></canvas>
</body>

</html>
